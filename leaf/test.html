<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
	#map {
		height: 100%;
	}
	#map> div:nth-of-type(2) {
		display: none;
	}
	/* Optional: Makes the sample page fill the window. */
	html, body {
		height: 100%;
		margin: 0;
		padding: 0;
	}
	</style>
</head>
<body>
	<div id="map"></div>
	<script src="https://maps.googleapis.com/maps/api/js"></script>
	<script src="rides_edited.js"></script>
	<script src="polylines.js"></script>
	<script>
		var map;
		function initialize() {
			var mapOptions = {
				zoom: 12,
				maxZoom: 18,
				minZoom: 10,
				center: {lat: 37.7578, lng:-122.5076}
			};
			var styles = {
				featureType: 'poi.business',
				stylers: [{visibility: 'off'}],
			};

			map = new google.maps.Map(document.getElementById('map'), mapOptions);
			map.setOptions({
				disableDoubleClickZoom: true,
				clickableIcons: false,
				styles: styles
			});
		}

		var flightPath;
		function render(rid) {
			if (rideID) return "DINGUS ALERT";
			// if (fixPath[rid].length > 2) return "already fixed";
			flightPath = new google.maps.Polyline({
				path: getCords(rid),
				editable: true,
				strokeColor: '#FF0000',
				strokeOpacity: 1.0,
				strokeWeight: 4,
				map: map
			});
			var bounds = new google.maps.LatLngBounds();
			flightPath.getPath().forEach(function(e){//can't do polyline.getPath()[i] because it's a MVCArray
				bounds.extend(e);
			})         
			map.fitBounds(bounds);

			google.maps.event.addListener(flightPath, 'click', function(e) {
				// Check if click was on a vertex control point
				if (e.vertex == undefined) return;
				removeVertex(flightPath.getPath(), e.vertex);
			});
			google.maps.event.addListener(map, "rightclick", function(e) {
				drawPoly(e)
			});
		}
		var rideID;
		function getCords(rid) {
			var latLng = polyline.decode(allRides[rid], 5);
			// latLng = fixPath[rid] != undefined && fixPath[rid].length > 2 ? polyline.decode(fixPath[rid], 5) : latLng;
			rideID = rid;
			var arr = [];
			latLng.forEach(c => {
				arr.push(new google.maps.LatLng(c[0],c[1]));
			});
			return arr;
		}

		function removeVertex(path, vertex) {
			if (!path || vertex == undefined) {
				return;
			}
			path.removeAt(vertex);
		}
		function path() {
			var p = polyline.encode(getPathLatLng());
			p = p.split(String.fromCharCode(92)).join(String.fromCharCode(92,92))
			// console.log(rideID + ': "' + p + '",');
			console.log(p);
			return rideID;
		}

		function getPathLatLng(){
			var latLng = [];
			var pathArr = flightPath.getPath();
			for (var i = 0; i < pathArr.length; i++){
				latLng.push([pathArr.getAt(i).lat().toFixed(5), pathArr.getAt(i).lng().toFixed(5)]);
			};
			return latLng;
		};

		// double clicks
		var bounds = [];
		var poly, hoverPoly, preview;
		function drawPoly(e) {
			if (flightPath == undefined) return;
			if (bounds.length == 2) {
				bounds = [];
				rect.setMap(null);
				console.log("Clearing selection");
				return;
			}
			// rectBounds.push(new google.maps.LatLng(cords[0],cords[1]));
			var clickedCords = [parseFloat(e.latLng.lat().toFixed(5)),parseFloat(e.latLng.lng().toFixed(5))]
			bounds.push(clickedCords);
			if (bounds.length == 1) {
				preview = google.maps.event.addListener(map, 'mousemove', (e) => {
					if (hoverPoly) hoverPoly.setMap(null);
					var hoverCords = [parseFloat(e.latLng.lat().toFixed(5)), parseFloat(e.latLng.lng().toFixed(5))];
					var cords = [
						{lat: clickedCords[0], lng: clickedCords[1]},
						{lat: clickedCords[0], lng: hoverCords[1]},
						{lat: hoverCords[0], lng: hoverCords[1]},
						{lat: hoverCords[0], lng: clickedCords[1]},
					];
					hoverPoly = new google.maps.Polygon({
						map: map,
						// bounds: new google.maps.LatLngBounds(rectBounds[0],rectBounds[1]),
						paths: cords,
						fillOpacity: 0.1,
						strokeWeight: 0.9,
						strokeOpacity: 0.5,
						fillColor: "#FFF",
						strokeColor: "#FFF",
						clickable: false,
					});
				})
			}
			if (bounds.length == 2) {
				hoverPoly.setMap(null);
				preview.remove();
				var cords = [
					{lat: bounds[0][0], lng: bounds[0][1]},
					{lat: bounds[0][0], lng: bounds[1][1]},
					{lat: bounds[1][0], lng: bounds[1][1]},
					{lat: bounds[1][0], lng: bounds[0][1]},
				];
				rect = new google.maps.Polygon({
					map: map,
					// bounds: new google.maps.LatLngBounds(rectBounds[0],rectBounds[1]),
					paths: cords,
					fillOpacity: 0.3,
					strokeWeight: 0.9,
					clickable: true,
					fillColor: "#FFF",
					strokeColor: "#FFF",
					editable: true,
				});
				google.maps.event.addListener(rect, "click", clearBounds);
			}
		}

		function clearBounds() {
			var pathArr = flightPath.getPath();
			for (var i = 0; i < pathArr.length; i++){
				var latLng = new google.maps.LatLng(pathArr.getAt(i).lat(), pathArr.getAt(i).lng())
				if (google.maps.geometry.poly.containsLocation(latLng, rect)) pathArr.removeAt(i);
			}
		}

		google.maps.event.addDomListener(window, 'load', initialize);
</script>
</body>
</html>